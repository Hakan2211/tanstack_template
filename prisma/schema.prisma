// schema.prisma

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "sqlite"
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  image         String?
  emailVerified Boolean   @default(false)

  // RBAC
  role String @default("user") // "admin", "user"

  // Auth
  accounts Account[]
  sessions Session[]

  // Billing
  stripeCustomerId      String?
  subscriptionStatus    String? // "active", "canceled", "past_due", "none"
  subscriptionTier      String? // "free", "starter", "pro"
  subscriptionPeriodEnd DateTime? // When the current billing period ends
  cancelAtPeriodEnd     Boolean   @default(false) // Whether subscription is set to cancel at period end

  // Subscription audit log
  subscriptionEvents SubscriptionEvent[]

  // Onboarding (optional - for multi-step onboarding flows)
  onboardingComplete Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user")
}

model Session {
  id        String   @id
  userId    String
  expiresAt DateTime
  token     String   @unique
  ipAddress String?
  userAgent String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("session")
}

model Account {
  id                    String    @id @default(cuid())
  userId                String
  accountId             String
  providerId            String
  accessToken           String?
  refreshToken          String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("account")
}

// For Magic Links / Email Verification
model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("verification")
}

// ====================================================================================
// Subscription Event Audit Log
// ====================================================================================

model SubscriptionEvent {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Event type: subscribed, upgraded, downgraded, canceled, reactivated, payment_failed, payment_succeeded
  event String

  // Tier changes (for upgrades/downgrades)
  fromTier String? // "free", "starter", "pro"
  toTier   String? // "free", "starter", "pro"

  // Additional metadata (JSON string)
  metadata String?

  // Stripe-related IDs for reference
  stripeEventId        String?
  stripeSubscriptionId String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([event])
  @@index([createdAt])
  @@map("subscription_event")
}
